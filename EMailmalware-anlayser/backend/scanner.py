import hashlib
import magic
import yara
import clamd
import os
from typing import Dict, Any, List

class MalwareScanner:
    def __init__(self, yara_rules_path: str = "yara_rules/suspicious_rules.yar"):
        # Initialize YARA
        try:
            self.rules = yara.compile(filepath=yara_rules_path)
        except Exception as e:
            print(f"Error compiling YARA rules: {e}")
            self.rules = None

        # Initialize ClamAV
        try:
            self.cd = clamd.ClamdNetworkSocket(host='clamav', port=3310)
        except Exception as e:
            print(f"Error connecting to ClamAV: {e}")
            self.cd = None

    def get_mime_type(self, file_path: str) -> str:
        mime = magic.Magic(mime=True)
        return mime.from_file(file_path)

    def calculate_sha256(self, file_path: str) -> str:
        sha256_hash = hashlib.sha256()
        with open(file_path, "rb") as f:
            for byte_block in iter(lambda: f.read(4096), b""):
                sha256_hash.update(byte_block)
        return sha256_hash.hexdigest()

    def scan_with_clamav(self, file_path: str) -> str:
        if not self.cd:
            return "ERROR (Not Connected)"
        try:
            result = self.cd.scan(file_path)
            # ClamAV returns {file_path: ('FOUND', 'VirusName')} or {file_path: ('OK', None)}
            if file_path in result:
                status, virus_name = result[file_path]
                if status == 'FOUND':
                    return f"INFECTED ({virus_name})"
            return "CLEAN"
        except Exception as e:
            return f"ERROR ({str(e)})"

    def scan_with_yara(self, file_path: str) -> List[str]:
        if not self.rules:
            return ["ERROR (Rules not loaded)"]
        try:
            matches = self.rules.match(file_path)
            return [str(match) for match in matches]
        except Exception as e:
            return [f"ERROR ({str(e)})"]

    def heuristic_checks(self, filename: str, mime_type: str) -> List[str]:
        flags = []
        # Double extension check
        if filename.count('.') > 1:
            flags.append("Double extension detected")
        
        # Executable check
        exec_types = ['application/x-executable', 'application/x-dosexec', 'application/x-sharedlib', 'application/x-msdos-program']
        if mime_type in exec_types or filename.endswith('.exe'):
            flags.append("Executable file type")

        # Suspicious keywords
        suspicious_keywords = ['invoice', 'payment', 'urgent', 'overdue', 'patch', 'update', 'salary']
        if any(keyword in filename.lower() for keyword in suspicious_keywords):
            flags.append("Suspicious filename keyword")

        return flags

    def calculate_risk_score(self, clamav_res: str, yara_res: List[str], heuristic_flags: List[str]) -> int:
        score = 0
        if "INFECTED" in clamav_res:
            score += 70
        if yara_res and "ERROR" not in yara_res[0]:
            score += 50
        if any("Executable" in f for f in heuristic_flags):
            score += 30
        if any("Suspicious filename" in f for f in heuristic_flags):
            score += 20
        
        return min(score, 100)

    def get_verdict(self, score: int) -> str:
        if score <= 30:
            return "CLEAN"
        if score <= 70:
            return "SUSPICIOUS"
        return "MALICIOUS"

    def scan_file(self, file_path: str) -> Dict[str, Any]:
        filename = os.path.basename(file_path)
        mime_type = self.get_mime_type(file_path)
        file_size = os.path.getsize(file_path)
        sha256 = self.calculate_sha256(file_path)

        clamav_result = self.scan_with_clamav(file_path)
        yara_result = self.scan_with_yara(file_path)
        heuristic_flags = self.heuristic_checks(filename, mime_type)
        
        risk_score = self.calculate_risk_score(clamav_result, yara_result, heuristic_flags)
        verdict = self.get_verdict(risk_score)

        return {
            "filename": filename,
            "file_type": mime_type,
            "file_size": f"{file_size / 1024:.2f} KB",
            "sha256": sha256,
            "clamav_result": clamav_result,
            "yara_result": yara_result,
            "heuristic_flags": heuristic_flags,
            "risk_score": risk_score,
            "verdict": verdict
        }
