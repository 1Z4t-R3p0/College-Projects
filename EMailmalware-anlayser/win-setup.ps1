Write-Host "==========================================" -ForegroundColor Cyan
Write-Host "   EMail Malware Analyzer Setup (Windows) " -ForegroundColor Cyan
Write-Host "==========================================" -ForegroundColor Cyan

$PROJECT_DIR = "$HOME\College-Projects"

# Check for Git
Write-Host "[*] Checking for Git..."
if (-not (Get-Command "git" -ErrorAction SilentlyContinue)) {
    Write-Host "[-] Error: Git is not installed or not in PATH." -ForegroundColor Red
    Write-Host "    Please install Git and try again." -ForegroundColor Red
    exit
}
Write-Host "[+] Git is installed." -ForegroundColor Green

# Check for Docker
Write-Host "[*] Checking for Docker..."
if (-not (Get-Command "docker" -ErrorAction SilentlyContinue)) {
    Write-Host "[-] Error: Docker is required to run this project." -ForegroundColor Red
    Write-Host "    Please install Docker Desktop and try again." -ForegroundColor Red
    exit
}
Write-Host "[+] Docker is installed." -ForegroundColor Green

# Clone Repository
Write-Host "[*] Setting up the College-Projects repository in $PROJECT_DIR..."
if (-not (Test-Path $PROJECT_DIR)) {
    git clone https://github.com/1Z4t-R3p0/College-Projects.git $PROJECT_DIR
    if ($LASTEXITCODE -ne 0) {
        Write-Host "[-] Failed to clone repository." -ForegroundColor Red
        exit
    }
}
else {
    Write-Host "[+] Repository already exists. Pulling latest changes..." -ForegroundColor Green
    Set-Location $PROJECT_DIR
    git pull
}

# Navigate to project
Write-Host "[*] Navigating to EMailmalware-anlayser directory..."
Set-Location "$PROJECT_DIR\EMailmalware-anlayser"

# Start Docker
Write-Host "[*] Starting Docker containers..."
docker compose up -d --build

if ($LASTEXITCODE -eq 0) {
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host "    System successfully deployed!         " -ForegroundColor Green
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host "Access the application at: http://localhost" -ForegroundColor Yellow
    Write-Host "Note: The ClamAV container may take a few minutes to download signatures on the first boot." -ForegroundColor Yellow
}
else {
    Write-Host "[-] Failed to start Docker containers." -ForegroundColor Red
}
