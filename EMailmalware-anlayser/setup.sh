#!/bin/bash

# ==============================================================================
# Email Attachment Malware Analysis System - Automated Setup Script
# ==============================================================================
# This script automates the installation of Docker, Docker Compose, 
# and launches the Malware Analysis System.
# ==============================================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}>>> Starting Malware Analysis System Setup...${NC}"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}Please run as root or with sudo.${NC}"
  exit 1
fi

# 1. Update and install dependencies
echo -e "${BLUE}>>> Updating system and installing dependencies...${NC}"
apt-get update
apt-get install -y ca-certificates curl gnupg lsb-release

# 2. Add Docker's official GPG key
echo -e "${BLUE}>>> Adding Docker GPG key...${NC}"
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg --yes

# 3. Set up the repository
echo -e "${BLUE}>>> Setting up Docker repository...${NC}"
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. Install Docker Engine
echo -e "${BLUE}>>> Installing Docker and Docker Compose...${NC}"
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 5. Verify Docker Installation
if docker --version > /dev/null 2>&1; then
    echo -e "${GREEN}Docker installed successfully: $(docker --version)${NC}"
else
    echo -e "${RED}Docker installation failed.${NC}"
    exit 1
fi

# 6. Launch the Malware Analysis System
echo -e "${BLUE}>>> Launching Malware Analysis System via Docker Compose...${NC}"
# Navigate to the project directory if we're not in it
PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$PROJECT_DIR"

docker compose up -d

# 7. Final Status Report
echo -e "${GREEN}==================================================================${NC}"
echo -e "${GREEN}Setup Complete!${NC}"
echo -e "${BLUE}The system is starting up in the background.${NC}"
echo -e "${BLUE}Access the interface at: http://localhost${NC}"
echo -e "${BLUE}Note: ClamAV initial update may take a few minutes.${NC}"
echo -e "${GREEN}==================================================================${NC}"
