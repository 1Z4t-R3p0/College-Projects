const uploadForm = document.getElementById('upload-form');
const fileInput = document.getElementById('file-upload');
const scanBtn = document.getElementById('scan-btn');
const resultCard = document.getElementById('result-card');
const selectedFilename = document.getElementById('selected-filename');

// Display filename on select
fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        selectedFilename.textContent = `Selected: ${fileInput.files[0].name}`;
    }
});

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!fileInput.files.length) return;

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    // UI Feedback
    scanBtn.disabled = true;
    scanBtn.textContent = 'Analyzing...';
    resultCard.classList.add('hidden');

    try {
        const response = await fetch('/api/scan', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Analysis failed');
        }

        const data = await response.json();
        displayResults(data);
    } catch (err) {
        alert(`Error: ${err.message}`);
    } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = 'Scan File';
    }
});

function displayResults(data) {
    resultCard.classList.remove('hidden');

    // Set Metadata
    document.getElementById('timestamp').textContent = `SCAN AT: ${new Date().toISOString().replace('T', ' ').split('.')[0]} UTC`;
    document.getElementById('res-filename').textContent = data.filename;
    document.getElementById('res-type').textContent = data.file_type;
    document.getElementById('res-size').textContent = data.file_size;
    document.getElementById('res-hash').textContent = data.sha256;

    // Set Verdict
    const verdictBox = document.getElementById('verdict-box');
    const verdictIcon = document.getElementById('verdict-icon');
    const verdictTitle = document.getElementById('verdict-title');
    const verdictDesc = document.getElementById('verdict-description');

    verdictBox.className = 'status-box'; // reset
    if (data.verdict === 'CLEAN') {
        verdictBox.classList.add('v-clean');
        verdictIcon.textContent = '✅';
        verdictTitle.textContent = 'File is Clean';
        verdictDesc.textContent = 'No malicious patterns or signatures were detected during the analysis.';
    } else if (data.verdict === 'SUSPICIOUS') {
        verdictBox.classList.add('v-suspicious');
        verdictIcon.textContent = '⚠️';
        verdictTitle.textContent = 'Suspicious Activity Detected';
        verdictDesc.textContent = 'Heuristic indicators suggest potentially harmful behavior. Proceed with caution.';
    } else {
        verdictBox.classList.add('v-malicious');
        verdictIcon.textContent = '❌';
        verdictTitle.textContent = 'Malicious File Detected';
        verdictDesc.textContent = 'Positive detection from primary security engines. The file has been flagged for quarantine.';
    }

    // Set Engine Details
    const clamavEl = document.getElementById('res-clamav');
    clamavEl.textContent = data.clamav_result;
    clamavEl.className = 'engine-status ' + (data.clamav_result === 'CLEAN' ? 'text-success' : 'text-danger');

    const yaraEl = document.getElementById('res-yara');
    yaraEl.textContent = data.yara_result.length > 0 ? data.yara_result.join(', ') : 'None';
    yaraEl.className = 'engine-status ' + (data.yara_result.length === 0 ? 'text-success' : 'text-danger');

    const heuristicEl = document.getElementById('res-heuristic');
    heuristicEl.textContent = data.heuristic_flags.length > 0 ? data.heuristic_flags.join(', ') : 'None';
    heuristicEl.className = 'engine-status ' + (data.heuristic_flags.length === 0 ? 'text-success' : 'text-warning');

    // Set Risk Score
    const scoreVal = document.getElementById('res-risk-score');
    scoreVal.textContent = `${data.risk_score}/100`;
    scoreVal.className = 'risk-number ' + getScoreColorClass(data.risk_score);

    const progress = document.getElementById('risk-progress');
    progress.style.width = `${data.risk_score}%`;
    progress.className = 'progress-fill ' + getProgressColorClass(data.risk_score);

    // Scroll to results
    resultCard.scrollIntoView({ behavior: 'smooth' });
}

function getScoreColorClass(score) {
    if (score <= 30) return 'text-success';
    if (score <= 70) return 'text-warning';
    return 'text-danger';
}

function getProgressColorClass(score) {
    if (score <= 30) return 'p-clean';
    if (score <= 70) return 'p-suspicious';
    return 'p-malicious';
}
